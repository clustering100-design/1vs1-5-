<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê²½ìŸ í•™ìŠµ ê²Œì„</title>
<style>
    /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼: Inter í°íŠ¸ ëŒ€ì‹  í•œêµ­ì–´ í™˜ê²½ì— ì í•©í•œ ì‹œìŠ¤í…œ í°íŠ¸ ì‚¬ìš© */
    body { 
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; 
        background-color: #1a1a2e; 
        color: #e0e0e0; 
    }
    /* ì§‘ì¤‘ë„ë¥¼ ë†’ì´ëŠ” ë‹¤í¬ í…Œë§ˆ */
    .container { 
        max-width: 1000px; 
        margin: 0 auto;
        padding: 1rem;
    }
    .card { 
        background-color: #2c2c4b; 
        border: 1px solid #4a4a75; 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); 
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .result-text { 
        font-size: 1.25rem; 
        font-weight: bold; 
        margin-top: 10px; 
    }
    .correct { 
        color: #50fa7b; 
    }
    .incorrect { 
        color: #ff5555; 
    }
    .timer-glow { 
        text-shadow: 0 0 10px #70a1ff; 
    }
    /* ëª¨ë°”ì¼ ìµœì í™”: ë¬¸ì œ ì˜ì—­ ë†’ì´ í™•ë³´ */
    @media (max-width: 768px) {
        #problem-display { 
            font-size: 2.5rem; 
        }
    }

    /* ìˆ¨ê¹€/ë³´ì„ UI í´ë˜ìŠ¤ */
    .hidden {
        display: none;
    }
    .flex {
        display: flex;
    }

    /* ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    button {
        cursor: pointer;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        background-color: #4a4a75;
        color: white;
        font-weight: bold;
    }
    button:disabled {
        background-color: #6a6a9a;
        cursor: not-allowed;
    }

    input[type="text"], input[type="number"] {
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #555;
        background-color: #222244;
        color: #eee;
        font-size: 1rem;
    }
</style>
</head>
<body>
<div class="container">

    <!-- ë‹‰ë„¤ì„ ì…ë ¥ ì˜ì—­ -->
    <div id="nickname-area" class="card">
        <label for="nickname-input">ë‹‰ë„¤ì„ ì…ë ¥:</label>
        <input id="nickname-input" type="text" maxlength="15" autocomplete="off" />
        <button id="start-button">ê²Œì„ ì‹œì‘</button>
    </div>

    <!-- ê²Œì„ UI ì˜ì—­ (ì‹œì‘ í›„ ë³´ì„) -->
    <div id="game-ui" class="card hidden">
        <div><strong id="player-nickname"></strong></div>
        <div>íƒ€ì´ë¨¸: <span id="timer-display">30:00</span></div>
        <div>ë‚´ ì ìˆ˜: <span id="my-score">0</span> / ë¼ì´ë²Œ ì ìˆ˜: <span id="rival-score">0</span></div>
        <div>ë‚œì´ë„: <span id="difficulty-level">ê¸°ì´ˆ (ë‹¨ìˆœ ë§ì…ˆ/ëº„ì…ˆ)</span></div>
        <hr/>
        <div id="problem-display" style="font-size:2rem; margin: 1rem 0;">ë¬¸ì œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
        <input id="answer-input" type="number" autocomplete="off" disabled />
        <button id="submit-button" disabled>í™•ì¸</button>
        <div id="feedback-message" class="result-text"></div>
        <hr/>
        <div>
            <strong>í†µê³„</strong><br/>
            ì´ ë¬¸ì œ: <span id="stats-total">0</span> /
            ì •ë‹µë¥ : <span id="stats-accuracy">0%</span> /
            ì—°ì† ì •ë‹µ: <span id="stats-streak">0</span> /
            ìµœê³  ì ìˆ˜: <span id="stats-best-score">0</span>
        </div>
    </div>

    <!-- ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="result-modal" class="hidden" style="position: fixed; top:0; left:0; width: 100vw; height: 100vh; 
        background: rgba(0,0,0,0.7); justify-content: center; align-items: center; color:#e0e0e0; z-index: 999;">
        <div style="background:#2c2c4b; border-radius: 8px; padding: 2rem; max-width: 400px; text-align:center;">
            <h2 id="modal-title">ê²Œì„ ì¢…ë£Œ</h2>
            <p>ìµœì¢… ì ìˆ˜: <span id="final-score">0</span></p>
            <p>ì •í™•ë„: <span id="final-accuracy">0%</span></p>
            <p>ìµœê³  ë‚œì´ë„: <span id="final-difficulty">ê¸°ì´ˆ</span></p>
            <p id="feedback-summary"></p>
            <button id="restart-button">ë‹¤ì‹œ ë„ì „</button>
        </div>
    </div>

</div>

<script>
    // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
    const GAME_DURATION = 30 * 60; // 30ë¶„ (ì´ˆ)
    const LOCAL_STORAGE_KEY = 'competitiveStudyApp';
    const RIval_SCORE_INCREMENT_INTERVAL = 5000; // 5ì´ˆë§ˆë‹¤ ë¼ì´ë²Œ ì ìˆ˜ ì—…ë°ì´íŠ¸

    let gameState = {
        nickname: 'í”Œë ˆì´ì–´',
        score: 0,
        rivalScore: 0,
        timeLeft: GAME_DURATION,
        totalProblems: 0,
        correctAnswers: 0,
        currentStreak: 0,
        maxStreak: 0,
        difficulty: 1, // 1: ê¸°ì´ˆ, 2: ì¼ë°˜, 3: ì‹¬í™”
        bestScore: 0,
        problemHistory: new Set(), // ë¬¸ì œ ì¤‘ë³µ ë°©ì§€ Set (ì˜ˆ: '12+5')
        isGameRunning: false,
        timerInterval: null,
        rivalInterval: null,
        lastSubmissionTime: 0,
        maxDifficultyReached: 1,
    };

    // --- UI ìš”ì†Œ ìºì‹œ ---
    const ui = {
        nicknameArea: document.getElementById('nickname-area'),
        startButton: document.getElementById('start-button'),
        gameUI: document.getElementById('game-ui'),
        nicknameInput: document.getElementById('nickname-input'),
        playerNickname: document.getElementById('player-nickname'),
        timerDisplay: document.getElementById('timer-display'),
        gameStatus: document.getElementById('game-status'),
        myScore: document.getElementById('my-score'),
        rivalScore: document.getElementById('rival-score'),
        difficultyLevel: document.getElementById('difficulty-level'),
        problemDisplay: document.getElementById('problem-display'),
        answerInput: document.getElementById('answer-input'),
        submitButton: document.getElementById('submit-button'),
        feedbackMessage: document.getElementById('feedback-message'),
        statsTotal: document.getElementById('stats-total'),
        statsAccuracy: document.getElementById('stats-accuracy'),
        statsStreak: document.getElementById('stats-streak'),
        statsBestScore: document.getElementById('stats-best-score'),
        resultModal: document.getElementById('result-modal'),
        modalTitle: document.getElementById('modal-title'),
        finalScore: document.getElementById('final-score'),
        finalAccuracy: document.getElementById('final-accuracy'),
        finalDifficulty: document.getElementById('final-difficulty'),
        feedbackSummary: document.getElementById('feedback-summary'),
        restartButton: document.getElementById('restart-button'),
    };

    // --- 1. ë°ì´í„° ë° ë¡œì»¬ ì €ì¥ì†Œ ê´€ë¦¬ ---

    /** ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ìƒíƒœ ë¡œë“œ */
    function loadState() {
        const data = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (data) {
            const savedState = JSON.parse(data);
            gameState.bestScore = savedState.bestScore || 0;
            ui.statsBestScore.textContent = gameState.bestScore.toLocaleString();
        }
    }

    /** ë¡œì»¬ ì €ì¥ì†Œì— í˜„ì¬ ìµœê³  ì ìˆ˜ ì €ì¥ */
    function saveBestScore() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
            bestScore: gameState.bestScore
        }));
    }

    // --- 2. ë¬¸ì œ ìë™ ê³µê¸‰ ë¡œì§ ---

    /** ë‚œì´ë„ì— ë”°ë¥¸ ë¬¸ì œ ë²”ìœ„ë¥¼ ì •ì˜ 
     * [ìµœì†Œê°’, ìµœëŒ€ê°’, ì ìˆ˜ ë°°ìœ¨, ë‚œì´ë„ ë ˆì´ë¸”]
     */
    const difficultyConfig = {
        1: [1, 10, 100, 'ê¸°ì´ˆ (ë‹¨ìˆœ ë§ì…ˆ/ëº„ì…ˆ)'], // 100ì 
        2: [10, 50, 200, 'ì¼ë°˜ (ë‘ ìë¦¬ ìˆ˜ ì—°ì‚°)'], // 200ì 
        3: [50, 100, 300, 'ì‹¬í™” (ì„¸ ìë¦¬ ìˆ˜ ì—°ì‚° / ê³±ì…ˆ ì¶”ê°€)'], // 300ì 
        4: [100, 500, 500, 'ìµœê³  ë‚œì´ë„ (ëŒ€ìˆ˜ / ë³µí•© ì—°ì‚°)'], // 500ì 
    };

    /** ë¬¸ì œ ì¤‘ë³µì„ í”¼í•˜ë©° ë‹¤ìŒ ë¬¸ì œë¥¼ ìƒì„± 
     * @returns {object} { text: 'A + B', answer: C, difficulty: D }
     */
    function generateProblem() {
        let maxAttempts = 10;
        let problem = null;

        while (maxAttempts > 0) {
            maxAttempts--;

            const config = difficultyConfig[gameState.difficulty];
            if (!config) break;

            const [min, max, score, label] = config;

            // ë‚œì´ë„ì— ë”°ë¼ ì—°ì‚° ì¢…ë¥˜ ê²°ì •
            let operators = ['+', '-'];
            if (gameState.difficulty >= 3) {
                operators.push('*');
            }

            const op = operators[Math.floor(Math.random() * operators.length)];

            // ë²”ìœ„ ë‚´ì—ì„œ ë‘ ìˆ«ì ìƒì„±
            const num1 = Math.floor(Math.random() * (max - min + 1)) + min;
            const num2 = Math.floor(Math.random() * (max - min + 1)) + min;

            let answer;
            let text;

            switch (op) {
                case '+':
                    answer = num1 + num2;
                    text = `${num1} + ${num2}`;
                    break;
                case '-':
                    // ìŒìˆ˜ ë°©ì§€ (ëº„ì…ˆì˜ ê²½ìš°)
                    if (num1 < num2) {
                        answer = num2 - num1;
                        text = `${num2} - ${num1}`;
                    } else {
                        answer = num1 - num2;
                        text = `${num1} - ${num2}`;
                    }
                    break;
                case '*':
                    answer = num1 * num2;
                    text = `${num1} * ${num2}`;
                    // ê³±ì…ˆì€ ë‚œì´ë„ë¥¼ ìœ„í•´ ìˆ«ìì˜ ë²”ìœ„ë¥¼ ì•½ê°„ ì œí•œ
                    if (num1 > 50 || num2 > 50) continue; 
                    break;
            }

            const problemKey = `${text}=${answer}`;

            // ë¬¸ì œ ì¤‘ë³µ ê²€ì‚¬
            if (!gameState.problemHistory.has(problemKey)) {
                problem = { text, answer, score, problemKey, difficulty: gameState.difficulty };
                gameState.problemHistory.add(problemKey);
                break;
            }
        }

        // ì¤‘ë³µëœ ë¬¸ì œê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì´ì „ ê¸°ë¡ì„ ì§€ìš°ê³  ìƒˆ ë¬¸ì œ ìƒì„± ìœ ë„ (ìƒˆ ë¬¸ì œ ìš°ì„  ì œê³µ ë¡œì§)
        if (!problem) {
            gameState.problemHistory.clear();
            return generateProblem(); 
        }

        return problem;
    }

    let currentProblem = null;

    /** ë¬¸ì œ ì¶œì œ ë° UI ì—…ë°ì´íŠ¸ */
    function setNextProblem() {
        currentProblem = generateProblem();
        ui.problemDisplay.textContent = currentProblem.text;
        ui.answerInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        ui.answerInput.focus(); // ìë™ í¬ì»¤ìŠ¤
        ui.feedbackMessage.textContent = ''; // í”¼ë“œë°± ë©”ì‹œì§€ ì´ˆê¸°í™”

        // ë‚œì´ë„ UI ì—…ë°ì´íŠ¸
        ui.difficultyLevel.textContent = difficultyConfig[gameState.difficulty][3];
        // ìµœê³  ë‚œì´ë„ ê¸°ë¡
        if (gameState.difficulty > gameState.maxDifficultyReached) {
            gameState.maxDifficultyReached = gameState.difficulty;
        }
    }

    /** ë‚œì´ë„ ìë™ ì¡°ì ˆ ë¡œì§ */
    function adjustDifficulty(isCorrect) {
        const MAX_DIFFICULTY = 4;
        const difficulty = gameState.difficulty;

        if (isCorrect) {
            gameState.currentStreak++;
            if (gameState.currentStreak > gameState.maxStreak) {
                gameState.maxStreak = gameState.currentStreak;
            }

            // 3ì—°ì† ì •ë‹µ ì‹œ ë‚œì´ë„ ìƒìŠ¹ (ìµœëŒ€ ë‚œì´ë„ 4)
            if (gameState.currentStreak >= 3 && difficulty < MAX_DIFFICULTY) {
                gameState.difficulty++;
                gameState.currentStreak = 0; // ë‚œì´ë„ ì¡°ì ˆ í›„ ìŠ¤íŠ¸ë¦­ ì´ˆê¸°í™”
                showFeedback('ë‚œì´ë„ ìƒìŠ¹! â¬†ï¸', 'text-yellow-400');
            }
        } else {
            gameState.currentStreak = 0; // ì˜¤ë‹µ ì‹œ ìŠ¤íŠ¸ë¦­ ì´ˆê¸°í™”

            // 2ì—°ì† ì˜¤ë‹µ ì‹œ ë‚œì´ë„ í•˜ë½ (ìµœì†Œ ë‚œì´ë„ 1)
            // (ì´ì „ ë¬¸ì œë„ í‹€ë ¸ë‹¤ê³  ê°€ì •í•˜ê³ , 2ë²ˆ í‹€ë¦¬ë©´ í•˜ë½ ë¡œì§ ì ìš©)
            if (difficulty > 1 && gameState.totalProblems > 0 && 
                gameState.correctAnswers < gameState.totalProblems - 1) { 

                gameState.difficulty--;
                showFeedback('ë‚œì´ë„ í•˜ë½ â¬‡ï¸ ë‹¤ì‹œ ì§‘ì¤‘!', 'text-red-400');
            }
        }
    }

    // --- 3. ê²Œì„ ì—”ì§„ ë° íƒ€ì´ë¨¸ ---

    /** íƒ€ì´ë¨¸ ì‹œì‘ */
    function startTimer() {
        gameState.isGameRunning = true;
        ui.gameStatus && (ui.gameStatus.textContent = 'ëŒ€ê²° ì§„í–‰ ì¤‘');

        gameState.timerInterval = setInterval(() => {
            gameState.timeLeft--;
            updateTimerDisplay();

            if (gameState.timeLeft <= 0) {
                endGame();
            }
        }, 1000);

        // ë¼ì´ë²Œ ì ìˆ˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ (ì‹¤ì œ ì„œë²„ê°€ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œë¡œ êµ¬í˜„)
        gameState.rivalInterval = setInterval(updateRivalScore, RIval_SCORE_INCREMENT_INTERVAL);
    }

    /** íƒ€ì´ë¨¸ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸ */
    function updateTimerDisplay() {
        const minutes = Math.floor(gameState.timeLeft / 60);
        const seconds = gameState.timeLeft % 60;
        ui.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // 1ë¶„ ë¯¸ë§Œ ê²½ê³  ìŠ¤íƒ€ì¼
        if (gameState.timeLeft < 60) {
            ui.timerDisplay.classList.add('text-red-500', 'animate-pulse');
        } else {
            ui.timerDisplay.classList.remove('text-red-500', 'animate-pulse');
        }
    }

    /** ë¼ì´ë²Œ ì ìˆ˜ ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸ */
    function updateRivalScore() {
        // ë¼ì´ë²Œì€ í‰ê· ì ìœ¼ë¡œ í”Œë ˆì´ì–´ë³´ë‹¤ ì•½ê°„ ë†’ê±°ë‚˜ ë‚®ì€ ì ìˆ˜ë¥¼ íšë“í•˜ë„ë¡ ì‹œë®¬ë ˆì´ì…˜
        const baseGain = Math.floor(Math.random() * 150) + 50; // 50~200ì 
        const difficultyFactor = gameState.difficulty * 0.1;
        const luckFactor = Math.random() < 0.3 ? 2 : 1; // ê°€ë” 2ë°° ì ìˆ˜

        // í”Œë ˆì´ì–´ ì ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚œì´ë„ì— ë”°ë¥¸ ì ìˆ˜ ì¦ê°€ ì‹œë®¬ë ˆì´ì…˜
        gameState.rivalScore += Math.round(baseGain * luckFactor * (1 + difficultyFactor));
        ui.rivalScore.textContent = gameState.rivalScore.toLocaleString();
    }

    /** ê²Œì„ ì¢…ë£Œ ë° ê²°ê³¼ í‘œì‹œ */
    function endGame() {
        clearInterval(gameState.timerInterval);
        clearInterval(gameState.rivalInterval);
        gameState.isGameRunning = false;

        // ì…ë ¥ ë¹„í™œì„±í™”
        ui.answerInput.disabled = true;
        ui.submitButton.disabled = true;
        ui.gameStatus && (ui.gameStatus.textContent = 'ê²Œì„ ì¢…ë£Œ');

        // ìµœê³  ì ìˆ˜ ì—…ë°ì´íŠ¸ ë° ì €ì¥
        if (gameState.score > gameState.bestScore) {
            gameState.bestScore = gameState.score;
            saveBestScore();
        }

        // ëª¨ë‹¬ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
        showResultModal();
    }

    // --- 4. ì‚¬ìš©ì ì…ë ¥ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

    /** ì •ë‹µ í™•ì¸ ë¡œì§ */
    function checkAnswer() {
        if (!gameState.isGameRunning || !currentProblem) return;

        const inputTime = Date.now();

        // ğŸš¨ ì•…ìš© ë°©ì§€ ê¸°ë³¸ ê¸°ëŠ¥: ë„ˆë¬´ ë¹ ë¥¸ ì—°ì† ë‹µë³€ ì œí•œ (0.5ì´ˆ ì´ë‚´)
        if (inputTime - gameState.lastSubmissionTime < 500) {
            showFeedback('ğŸš¨ ë„ˆë¬´ ë¹ ë¦…ë‹ˆë‹¤! ì²œì²œíˆ í’€ì–´ìš”.', 'text-red-500');
            return;
        }
        gameState.lastSubmissionTime = inputTime;

        const userAnswer = parseInt(ui.answerInput.value, 10);

        if (isNaN(userAnswer)) {
            showFeedback('ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'text-yellow-500');
            return;
        }

        gameState.totalProblems++;
        let isCorrect = (userAnswer === currentProblem.answer);

        if (isCorrect) {
            gameState.correctAnswers++;
            gameState.score += currentProblem.score;
            showFeedback(`ì •ë‹µ! (+${currentProblem.score}ì )`, 'correct');
        } else {
            gameState.score -= Math.floor(currentProblem.score / 5); // ì˜¤ë‹µ ì‹œ í˜ë„í‹°
            if (gameState.score < 0) gameState.score = 0;
            showFeedback(`ì˜¤ë‹µ âŒ ì •ë‹µ: ${currentProblem.answer}`, 'incorrect');
        }

        // ì ìˆ˜ ë° í†µê³„ ì—…ë°ì´íŠ¸
        updateStats(isCorrect
